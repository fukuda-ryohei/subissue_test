name: Create Sub-Issue

on:
  issues:
    types: [opened]

permissions:
  issues: write
  contents: read

jobs:
  create-sub-issue:
    runs-on: ubuntu-latest
    steps:
    - name: Check out repository
      uses: actions/checkout@v2

    - name: Check if the issue uses the develop template
      id: check_template
      uses: actions/github-script@v3
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const issue_body = context.payload.issue.body;
          const is_develop_template = issue_body.includes('This is a develop issue template');
          return { is_develop_template };

    - name: Read sub-issue template
      id: read_template
      if: steps.check_template.outputs.is_develop_template == 'true'
      run: |
        sub_issue_template=$(sed -n '/^---$/,$!p' .github/ISSUE_TEMPLATE/sub.md)
        echo "sub_issue_template<<EOF" >> $GITHUB_ENV
        echo "$sub_issue_template" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV

    - name: Create Sub-Issue
      if: steps.check_template.outputs.is_develop_template == 'true'
      uses: actions/github-script@v3
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const { owner, repo } = context.repo;
          const issue_number = context.payload.issue.number;
          const subIssueBody = process.env.sub_issue_template;
          const newIssue = await github.issues.create({
            owner,
            repo,
            title: `Sub-Issue for #${issue_number}`,
            body: subIssueBody,
            labels: ['sub-issue'],
          });
          await github.issues.createComment({
            owner,
            repo,
            issue_number,
            body: `Sub-issue created: #${newIssue.data.number}`
          });